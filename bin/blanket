#!/usr/bin/env ruby

load File.dirname(__FILE__) + "/../lib/init.rb"


class Confluence
  

  def initialize(config_file)
    @options = YAML.load_file(config_file)
  end
  
  def password
    @options["password"]
  end
  
  def host
    @options["host"]
  end
  
  def user
    @options["user"]
  end
  
  def begin_connection
    begin
      if password
        @session = Net::SSH.start(host, user, password)
      else
        @session = Net::SSH.start(host, user)
      end
    rescue SocketError => e
      puts "!!! Could not connect to #{host}. Check to make sure that this is the correct url."
      exit
    rescue Net::SSH::AuthenticationFailed => e
      puts "!!! Could not authenticate on #{host}. Make sure you have set the username and password correctly."
      exit
    end
  end
  
  def issue_command
    @session.open_channel do |channel|
      puts "Connected to #{@session.host}...\n"

      @buffer = ""
      channel.request_pty :want_reply => true

      channel.on_data do |ch, data|
        @buffer << data
        parse_line(data)
      end

      channel.on_success do |ch|
        channel.exec "#{command} #{file}  "
      end

      channel.on_failure do |ch|
        ch.close
      end

      channel.on_extended_data do |ch, data|
        puts "STDERR: #{data}\n"
      end

      channel.on_close do |ch|
        ch[:closed] = true
      end

      puts "Pushing #{host}\n" if($VRB > 0 || $DBG > 0)
      @channels.push(channel)
    end
  end

  
  def blanket

  end
end
